<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機械手臂控制系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        #video-feed {
            width: 100%;
            max-width: 640px;
        }
        .stats {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot me-2"></i>
                <strong>機械手臂控制系統</strong>
            </a>
        </div>
    </nav>
    <div class="container">
        <h1 class="mt-4">機械手臂控制系統</h1>
        <div class="row">
            <div class="col-md-8">
                <h3>即時影像</h3>
                <img id="video-feed" src="" alt="攝影機影像">
            </div>
            <div class="col-md-4">
                <h3>控制</h3>
                <button class="btn btn-success mb-2">啟動</button>
                <button class="btn btn-danger mb-2">停止</button>
                <h3 class="stats">物件統計</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>類型</th>
                            <th>數量</th>
                        </tr>
                    </thead>
                    <tbody id="object-counts">
                        <tr><td>紅色</td><td id="red-count">0</td></tr>
                        <tr><td>藍色</td><td id="blue-count">0</td></tr>
                        <tr><td>黃色</td><td id="yellow-count">0</td></tr>
                        <tr><td>綠色</td><td id="green-count">0</td></tr>
                        <tr><td>破損</td><td id="broken-count">0</td></tr>
                        <tr><td>未知</td><td id="unknown-count">0</td></tr>
                        <tr><td>總數</td><td id="total-count">0</td></tr>
                        <tr><td>良好率</td><td id="good-rate">0%</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof io === 'undefined') {
                console.error('Socket.IO 庫載入失敗，請檢查網路或 CDN');
                return;
            }

            const socket = io('http://localhost:3000');
            console.log('Socket 初始化:', socket);

            socket.on('connect', () => {
                console.log('已連接到伺服器');
            });

            socket.on('frame', (data) => {
                console.log('收到影像數據:', data);
                // 直接使用 data，因為它已經是 base64 字符串
                if (typeof data !== 'string' || data.length === 0) {
                    console.error('無效的 base64 字符串:', data);
                    return;
                }
                document.getElementById('video-feed').src = `data:image/jpeg;base64,${data}`;
            });

            socket.on('object_counts', (data) => {
                document.getElementById('red-count').textContent = data.counts.red || 0;
                document.getElementById('blue-count').textContent = data.counts.blue || 0;
                document.getElementById('yellow-count').textContent = data.counts.yellow || 0;
                document.getElementById('green-count').textContent = data.counts.green || 0;
                document.getElementById('broken-count').textContent = data.counts.broken || 0;
                document.getElementById('unknown-count').textContent = data.counts.unknown || 0;
                document.getElementById('total-count').textContent = data.total;
                document.getElementById('good-rate').textContent = `${data.good_rate}%`;
            });

            function sendControl(command) {
                console.log('發送指令:', command);
                socket.emit('control', { command });
            }

            document.querySelector('.btn-success').addEventListener('click', () => sendControl('start'));
            document.querySelector('.btn-danger').addEventListener('click', () => sendControl('stop'));
        });
    </script>
</body>
</html>